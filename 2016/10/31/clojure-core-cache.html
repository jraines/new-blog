<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <link href="../../../stylesheets/syntax.css" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/main.css" rel="stylesheet" type="text/css" />

    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <title>Jeremy Raines - clojure.core.cache</title>

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div id="main" role="main">
      <h1>clojure.core.cache</h1>

<p><a href="https://github.com/clojure/core.cache/">clojure.core.cache</a> provides a functional in-memory cache. It provides different built-in cache types, like TTL, LRU, or others. Like other clojure data structures, it is immutable.  I&rsquo;ve found the following pattern useful for reckoning with that immutability.</p>

<p>In this example, we store weather forecasts provided by an external API for a given zip code and cache the results for that zip code for half a day.</p>
<pre><code class="highlight clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">foo.weather</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">org.httpkit.client</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">http</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">foo.zips</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">zips</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.core.cache</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">cache</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.data.json</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">json</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="s">"https://api.darksky.net/forecast/an-api-key/"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">half-day</span><span class="w">
  </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="c1">;milliseconds -&gt; seconds
</span><span class="w">     </span><span class="mi">60</span><span class="w">   </span><span class="c1">;seconds -&gt; minutes
</span><span class="w">     </span><span class="mi">60</span><span class="w">   </span><span class="c1">;mins -&gt; hours
</span><span class="w">     </span><span class="mi">12</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">forecasts-cache</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">(</span><span class="nf">cache/ttl-cache-factory</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="no">:ttl</span><span class="w"> </span><span class="n">half-day</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">parse-response</span><span class="w">
  </span><span class="p">[</span><span class="n">url</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">resp</span><span class="w"> </span><span class="err">@</span><span class="p">(</span><span class="nf">http/get</span><span class="w"> </span><span class="n">url</span><span class="p">)</span><span class="w">
        </span><span class="n">forecast</span><span class="w"> </span><span class="p">(</span><span class="nf">json/read-str</span><span class="w"> </span><span class="p">(</span><span class="no">:body</span><span class="w"> </span><span class="n">resp</span><span class="p">)</span><span class="w"> </span><span class="no">:key-fn</span><span class="w"> </span><span class="nb">keyword</span><span class="p">)</span><span class="w">
        </span><span class="n">daily</span><span class="w"> </span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="n">forecast</span><span class="w"> </span><span class="p">[</span><span class="no">:daily</span><span class="w"> </span><span class="no">:data</span><span class="p">])</span><span class="w">
        </span><span class="n">today</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="n">daily</span><span class="p">)]</span><span class="w">
    </span><span class="n">today</span><span class="p">))</span><span class="w">

</span><span class="c1">;fn which does the work on a cache miss
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">forecast*</span><span class="w">
  </span><span class="p">[</span><span class="n">zip</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">latlong</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">zips/zips</span><span class="w"> </span><span class="n">zip</span><span class="p">)</span><span class="w">
        </span><span class="n">url</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.string/join</span><span class="w"> </span><span class="s">","</span><span class="w"> </span><span class="n">latlong</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">parse-response</span><span class="w"> </span><span class="n">url</span><span class="p">)))</span><span class="w">

</span><span class="c1">;fn that tries to return cached values
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">forecast</span><span class="w">
  </span><span class="p">[</span><span class="n">zip</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">cache/has?</span><span class="w"> </span><span class="err">@</span><span class="n">forecasts-cache</span><span class="w"> </span><span class="n">zip</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="p">(</span><span class="nf">cache/hit</span><span class="w"> </span><span class="err">@</span><span class="n">forecasts-cache</span><span class="w"> </span><span class="n">zip</span><span class="p">)</span><span class="w"> </span><span class="n">zip</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">updated-cache</span><span class="w"> </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">forecasts-cache</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">cache/miss</span><span class="w"> </span><span class="n">%</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="nf">forecast*</span><span class="w"> </span><span class="n">zip</span><span class="p">)))]</span><span class="w">
      </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">updated-cache</span><span class="w"> </span><span class="n">zip</span><span class="p">))))</span><span class="w">
</span></code></pre>

    </div>
  </body>
</html>
